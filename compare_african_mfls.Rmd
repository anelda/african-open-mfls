---
title: "Comparing African Open Master Facility Lists"
author: "Anelda van der Walt"
date: "07 May 2020"
output: html_document
---

# Background

In February 2020 the [_afrimapr_](http://afrimapr.org) team set out to develop building blocks in R that would make open health facility data more accessible to data scientists in Africa and elsewhere. The [`afrihealthsites`](http://afrimapr.org/code) package aims to provide functionality to load, analyse, visualise, and map open health facility datasets such as the one compiled by [KEMRI-Wellcome for sub-Saharan Africa](https://www.ncbi.nlm.nih.gov/pubmed/31346183) and the data made available via the Global Healthsites Mapping Project ([healthsites.io](https://healthsites.io/)). 

Through our research we learned about the term `master facility list` (MFL). A master facility list contains information about the full complement of health facilities in a country. The World Health Organisation developed [a guide](https://www.who.int/healthinfo/country_monitoring_evaluation/mfl/en/) for countries wanting to develop their own MFL or wanting to strengthen existing MFLs.

We were excited to find several African MFLs available online. This work forms part of a research paper that we're working on. We wanted to perform some exploratory analysis on the MFLs from different countries to understand the overlaps and differences in terms of information that is made available, data format, and more.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

library(here)
library(readxl)
library(readr)
library(dplyr)
library(stringr)

# For maps
library(sf)
library(raster)
library(tmap)
library(spData)
library(leaflet)
library(cartogram)
library(googlesheets4)
library(countrycode)

# Working with Namibian JSON
library(jsonlite)

# Tables
library(kableExtra)
library(afrihealthsites)

# Interactive bubble plot
library(plotly)
library(viridis)
library(hrbrthemes)
library(htmlwidgets)

# Wordcloud
library(wordcloud2)
library(frequency)
```

```{r map_open_lists}

# Load Google Sheet describing African open health facility lists
# This sheet is now published as CSV and can be read directly from the URL without needing oauth
africa_lists <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4rHsHzAx_lnA9G0DJy-zjQvboAc2KpcvEIUgvbwanp7U5pPbcHzmpCQjz0Cw0YVujxOp5HypAXqPl/pub?gid=1678013670&single=true&output=csv")

# Add column with iso2c codes for use in mapping
africa_lists <- africa_lists %>% 
  mutate(country_iso = countrycode(Country, origin = "country.name", destination = "iso2c")) %>% 
  relocate(country_iso, .after = "Country") %>% 
  # Add column for use in mapping
  mutate(`Open facility list online` = case_when(`Official MFL accessible online` == "Yes" ~ "Official MoH MFL",
                                                 `Official MFL accessible online` == "No" ~ "Other source",
                                                 `Official MFL accessible online` == "Unclear" ~ "Official status unclear"))

# Merge world data from spData with africa_lists created in previous step for to obtain African polygons
# Select only relevent columns
africa <-  world %>%
  filter(continent == "Africa", !is.na(iso_a2)) %>%
  right_join(africa_lists, by = c("iso_a2" = "country_iso")) %>%
  dplyr::select(name_long, `Official MFL accessible online`, `Open facility list online`, Owner, License, 
                `Download format`, `Downloaded data geocoded`, `Health facility data URL`, `About page URL`, 
                `Alternative health facilities data source`, `Last updated`, geom) %>% 
  st_transform("+proj=aea +lat_1=20 +lat_2=-23 +lat_0=0 +lon_0=25")

# Draw map
tmap_mode("view")
tm_shape(africa) + 
  tm_polygons("Open facility list online",
              # Create list of items that will show when clicking on a country
              popup.vars=c("Owner: "="Owner", "License: "="License", 
                           "Recognised as official MFL: "="Official MFL accessible online",
                           "Download format: " = "Download format", "Geocoded: "="Downloaded data geocoded", 
                           "Last updated: "="Last updated"))

tmap_mode("plot")

# Clean up
remove(africa, africa_lists)

```


# Obtaining the data

## Kenya

The Kenyan MFL is available at http://kmhfl.health.go.ke/#/home. The data is downloadable in Excel format (although there seem to be an API as well, but we did not use the API). Unfortunately one has to visit the website and physically click on the `Export Excel` button to obtain the data. Once downloaded to our `data/raw_data` folder, the data is easily loaded using the function `read_xlsx` from the `read_xl` package.

```{r kenya}

ken_mfl <- read_xlsx(here("data", "raw_data", "kenya.xlsx"))

```

```{r kenya_table}

ken_mfl[1:2,] %>%  kableExtra::kable() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) %>% 
  kableExtra::scroll_box(width = "100%") %>% 
  kableExtra::footnote(general = "An excerpt showing the column headers and format of the raw data available from the Kenyan MFL")

```

## Malawi

The Malawi MFL is available at http://zipatala.health.gov.mw/facilities and can be downloaded in Excel or PDF format. A API exist but more information was not available so we visited the website and downloaded the data to our `data/raw_data` folder by clicking on the `DOWNLOAD EXCEL` button.

```{r malawi}

mwi_mfl <- read_xlsx(here("data", "raw_data", "malawi.xlsx"))

```
```{r malawi_table}

mwi_mfl[1:2,] %>%  kableExtra::kable() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) %>% 
  kableExtra::scroll_box(width = "100%") %>% 
  kableExtra::footnote(general = "An excerpt showing the column headers and format of the raw data available from the Malawian MFL")

```
## Namibia

The [MFL for Namibia](https://mfl.mhss.gov.na/home) is accessible via an API as [described on the website](https://mfl.mhss.gov.na/api/docs). The data can also be downloaded in Excel format directly from the website, but it should be noted that the resultant Excel file contains a very small subset of the total attributes available.

We had some trouble reading the JSON file in R and decided to develop a script in Python that could access the JSON for each facility and convert the dataset to an object that could further be analysed here in R alongside the other country MFLs.

Details of the data structure and download process are available from the [Jupyter Notebook](python_notebooks/namibia_mfl_convert.ipynb).


```{r namibia}

# Can't download straight from API due to Certificate issues
# Error in open.connection(con, "rb") : 
#  server certificate verification failed. CAfile: /etc/ssl/certs/ca-certificates.crt CRLfile: none
# Decided to try in Python - see python_notebooks/namibia_mfl_convert.ipynb
# Heavily nested JSON teased apart in Python and saved to CSV from Jupyter Notebook to be used in R

nam_mfl <- read_csv(here("data", "raw_data", "namibia.csv"))

```

```{r namibia_table}

nam_mfl[1:2,] %>%  kableExtra::kable() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) %>% 
  kableExtra::scroll_box(width = "100%") %>% 
  kableExtra::footnote(general = "An excerpt showing the column headers and format of the raw data available from the Namibian MFL")

```
## Rwanda

Rwanda makes [their MFL](https://moh.gov.rw/index.php?id=547) available in CSV, Excel or PDF format. Again one has to visit the provided webpage anc physically click on the `CSV` button to download the data.

The raw data contains two instances of the `District` column that seems to be a duplicate in terms of values stored in this column. 

```{r rwanda}

rwa_mfl <- read_csv(here("data", "raw_data", "rwanda.csv"))

```

```{r rwanda_table}

rwa_mfl[1:2,] %>%  kableExtra::kable() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) %>% 
  kableExtra::scroll_box(width = "100%") %>% 
  kableExtra::footnote(general = "An excerpt showing the column headers and format of the raw data available from the Rwandan MFL")

```

## South Sudan

The South Sudan facilities list is available in CSV format from https://www.southsudanhealth.info/facility/fac.php?list. The data can be accessed directly in CSV format via the link - https://www.southsudanhealth.info/PublicData/facility_info_2020-05-08.csv.

```{r south_sudan}

ssd_mfl <- read_csv("https://www.southsudanhealth.info/PublicData/facility_info_2020-05-08.csv")

```

```{r s_sudan_table}

ssd_mfl[1:2,] %>%  kableExtra::kable() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) %>% 
  kableExtra::scroll_box(width = "100%") %>% 
  kableExtra::footnote(general = "An excerpt showing the column headers and format of the raw data available from the South Sudan MFL")

```

## Tanzania

For Tanzania the MFL is available at http://hfrportal.moh.go.tz/index.php?r=page/index&page_name=about_page with data downloadable in Excel format (XLS). The geocoded data can directly be accessed [via a URL](http://hfrportal.moh.go.tz/index.php?r=facilities/exportToExcel&url=https%3A%2F%2Fresourcemap.instedd.org%2Fapi%2Fcollections%2F409.json%3Fpage%3Dall%26box%3D-180%2C-90%2C179.99%2C90%26Admin_div%5Bunder%5D%3DTZ%26human%3Dtrue&report_title=List_of_Facilities_with_Geo) with no need for physically interacting with the website. It should be noted that the data can be cashed as empty dataset. If the downloaded file contains no data, please visit the website and ensure all geocoded facilities are selected.

There are also 1,378 facilities without coordinates in this database. These can be downloaded by visiting [this URL](http://hfrportal.moh.go.tz/index.php?r=facilities/exportToExcel&url=https%3A%2F%2Fresourcemap.instedd.org%2Fapi%2Fcollections%2F409.json%3Fpage%3Dall%26location_missing%3Dtrue%26Admin_div%5Bunder%5D%3DTZ%26human%3Dtrue&report_title=List_of_Facilities_with_No_Geo).

Thankfully these two datasets contain the same columns (`Latitude` and `Longitude` is retained in the non-geocoded file). We can therefore merge the two datasets easily for combined analysis.

Unfortunately, the very first row of the Excel sheet is made up of merged cells. The row contains information about the date and time of download of the data and can be deleted. Because of the merged cells, the data has to be downloaded to disk, opened in Excel or LibreOffice or other spreadsheet package. The first row has to be removed and the file saved. Only after this can the file be loaded successfully in R.

```{r tanzania}

tanzania_geocode <- read_xls(here("data", "raw_data", "tanzania_geocoded.xls"))
tanzania_nongeocode <- read_xls(here("data", "raw_data", "tanzania_nongeocoded.xls"))

tza_mfl <- tanzania_geocode %>% 
  bind_rows(tanzania_nongeocode)

remove(tanzania_nongeocode, tanzania_geocode)

```

```{r tanzania_table}

tza_mfl[1:2,] %>%  kableExtra::kable() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) %>% 
  kableExtra::scroll_box(width = "100%") %>% 
  kableExtra::footnote(general = "An excerpt showing the column headers and format of the raw data available from the Tanzanian MFL")

```

## Zambia

The Zambian MFL is [hosted on Github](https://github.com/MOH-Zambia/MFL/). The raw data is available in CSV format in the [Github repository](https://raw.githubusercontent.com/MOH-Zambia/MFL/master/geography/data/facility_list.csv).

```{r zambia}

zmb_mfl <- read_csv("https://raw.githubusercontent.com/MOH-Zambia/MFL/master/geography/data/facility_list.csv")

```

```{r zambia_table}

zmb_mfl[1:2,] %>%  kableExtra::kable() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) %>% 
  kableExtra::scroll_box(width = "100%") %>% 
  kableExtra::footnote(general = "An excerpt showing the column headers and format of the raw data available from the Zambian MFL")

```


# Loading other open health facility data sets

We can also access the open health facility data available through the [KEMRI-Wellcome group](https://www.ncbi.nlm.nih.gov/pubmed/31346183) and [healthsites.io](https://healthsites.io/). Both these datasets can be accessed via the `afrimapr` [`afrihealthsites` package](http://afrimapr.org/code).

```{r create_country_lists}
# Create vector with iso3 code of country
countries <- c("ken", "mwi", "nam", "rwa", "ssd","tza", "zmb")

```

```{r afrimapr}
# Loop through list of countries to create dataframes for each country containing either WHO data or Healthsites.io data
for (country in countries){
  # Use iso3 code to extract country level data
  # Return dataframe (by default afrihealthsites return geoJSON
  # but not all facilities in WHO dataset is geocoded and some are lost in geoJSON format)
  who_df <- afrihealthsites(country, datasource='who', plot=FALSE, returnclass='dataframe')
  hs_df <- afrihealthsites(country, datasource='healthsites', plot=FALSE, returnclass='dataframe')
  
  # Create one dataframe per country per data source
  assign(paste0(country,"_who"), who_df)
  assign(paste0(country,"_hs"), hs_df)
  
  # Clean up workspace - remove temp dataframes
  remove(who_df, hs_df, country)
}

```

Below are excerpts from the WHO and healthsites.io data for Kenya to give the reader an overview of column headers and data format.

#### Kenya: WHO dataset

```{r kenya_who_table}

ken_who[1:2,] %>%  kableExtra::kable() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) %>% 
  kableExtra::scroll_box(width = "100%") %>% 
  kableExtra::footnote(general = "An excerpt showing the column headers and format of the raw data available from the WHO data for Kenya")

```


#### Kenya: healthsites.io dataset

```{r kenya_hs_table}

ken_hs[1:2,] %>%  kableExtra::kable() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) %>% 
  kableExtra::scroll_box(width = "100%") %>% 
  kableExtra::footnote(general = "An excerpt showing the column headers and format of the raw data available from the healthsites.io data for Kenya")

```

# Exploring the data

## Number of facilities per dataset

```{r data_prep}

# Create dataframe with number of observations and number of columns for each dataset
# Step 1: Create vector for dataset names
dataset_names <- c(ls(pattern = "mfl"), ls(pattern = "who"), ls(pattern = "hs"))

# Step 2: Create vector for # observations and # columns per dataset
# Step 2a: Create list of dataframes to run nrow, ncol on
datasets <- mget(dataset_names)

# Step 2b: Create vectors
dataset_obs <- c()
dataset_cols <- c()
for (ds in datasets){
  dataset_obs <- append(dataset_obs, nrow(ds))
  dataset_cols <- append(dataset_cols, ncol(ds))
}

# Step 3: Create dataframe with everything combined
health_lists_df <- tibble(Dataset = dataset_names, 
                    Facilities = dataset_obs,
                    Attributes = dataset_cols)
health_lists_df <- health_lists_df %>% 
  mutate(Country = case_when(str_detect(Dataset, "ken") ~ "Kenya",
                             str_detect(Dataset, "mwi") ~ "Malawi",
                             str_detect(Dataset, "nam") ~ "Namibia",
                             str_detect(Dataset, "rwa") ~ "Rwanda",
                             str_detect(Dataset, "ssd") ~ "South Sudan",
                             str_detect(Dataset, "tza") ~ "Tanzania",
                             str_detect(Dataset, "zmb") ~ "Zambia")) %>% 
  mutate(`Data Source` = case_when(str_detect(Dataset, "mfl") ~ "Master facility list",
                                   str_detect(Dataset, "who") ~ "WHO",
                                   str_detect(Dataset, "hs") ~ "healthsites.io")) %>% 
  mutate(text = paste("Country: ", Country, "\nData source: ", `Data Source`, "\nFacilities: ", Facilities, "\nAttributes: ", Attributes, sep="")) %>%
  mutate(Dataset = factor(Dataset, Dataset))

# Step 4: Remove clutter
remove(dataset_names, dataset_obs, dataset_cols, ds)

```

```{r compare_mfls}

health_lists_df %>% 
  group_by(Country) %>% 
  ggplot(aes(x = Country, y = Facilities, fill = `Data Source`)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_viridis(discrete = TRUE) +
  theme_minimal()

```

## Facility types

If we want to compare the types of facilities listed in each dataset, we first have to (manually) identify the column that contains information about facility type.

```{r extracting_types}

k_types <- unique(ken_mfl$`Facility type`)

m_types <- unique(mwi_mfl$TYPE)

r_types <- unique(rwa_mfl$`Facility type`)

s_types <- unique(ssd_mfl$type)

t_types <- unique(tza_mfl$`Facility Type`)

z_types <- unique(zmb_mfl$facility_type)

# Can't write function for next step because column names vary between datasets
# Get the names of WHO country dataframes
names_who <- c(ls(pattern = "^\\w\\w\\w_who$"))

# Get the WHO country dataframe content
datasets_who <- mget(names_who)

# Create vectors with country name and types
who_country <- c()
who_types <- c()
for (who in datasets_who){
  who_country <- append(who_country, unique(who$Country))
  who_types <- append(who_types, list(unique(who$`Facility type`)))
}

# Create dataframe with country name in first column and unique facility types observed in second column
who_fac_types <- tibble(country = who_country,
                        types = who_types)

# Get the names of WHO country dataframes
names_hs <- c(ls(pattern = "^\\w\\w\\w_hs$"))

# Get the WHO country dataframe content
datasets_hs <- mget(names_hs)

# Create vectors with country name and types
hs_country <- c()
hs_types <- c()
for (hs in datasets_hs){
  hs_country <- append(hs_country, unique(hs$country))
  hs_types <- append(hs_types, list(unique(hs$amenity)))
}

# Create dataframe with country name in first column and unique facility types observed in second column
hs_fac_types <- tibble(country = hs_country,
                        types = hs_types)

```

Here is the mapping:

The columns containing facility types in the WHO dataset and healthsites.io were respectively named `Facility type` and `amenity`.

- Kenya: column containing facility types in MFL = `Facility type`

    - MFL: `r paste(k_types, sep = ", ")`
    - WHO: `r paste(unlist(who_fac_types$types[who_fac_types$country == "Kenya"]), collapse = ", ")`
    - healthsites.io: `r paste(unlist(hs_fac_types$types[hs_fac_types$country == "Kenya"]), collapse = ", ")`
  
- Malawi: column containing facility types in MFL = `TYPE`

    - MFL: `r paste(m_types, sep = ", ")`
    - WHO: `r paste(unlist(who_fac_types$types[who_fac_types$country == "Malawi"]), collapse = ", ")`
    - healthsites.io: `r paste(unlist(hs_fac_types$types[hs_fac_types$country == "Malawi"]), collapse = ", ")`
  
- Namibia: No column for facility types in MFL

    - WHO: `r paste(unlist(who_fac_types$types[who_fac_types$country == "Namibia"]), collapse = ", ")`
    - healthsites.io: `r paste(unlist(hs_fac_types$types[hs_fac_types$country == "Namibia"]), collapse = ", ")`
  
- Rwanda: Column name for facility types in MFL = `Facility type`

    - MFL: `r paste(r_types, sep = ", ")`
    - WHO: `r paste(unlist(who_fac_types$types[who_fac_types$country == "Rwanda"]), collapse = ", ")`
    - healthsites.io: `r paste(unlist(hs_fac_types$types[hs_fac_types$country == "Rwanda"]), collapse = ", ")`
  
- South Sudan: Column name for facility types in MFL = `type`

    - MFL: `r paste(s_types, sep = ", ")`
    - WHO: `r paste(unlist(who_fac_types$types[who_fac_types$country == "South Sudan"]), collapse = ", ")`
    - healthsites.io: `r paste(unlist(hs_fac_types$types[hs_fac_types$country == "South Sudan"]), collapse = ", ")`
  

- Tanzania: Column name for facility types in MFL = `Facility Type`

    - MFL: `r paste(t_types, sep = ", ")`
    - WHO: `r paste(unlist(who_fac_types$types[who_fac_types$country == "Tanzania"]), collapse = ", ")`
    - healthsites.io: `r paste(unlist(hs_fac_types$types[hs_fac_types$country == "Tanzania"]), collapse = ", ")`
  
- Zambia: Column name for facility types in MFL = `facility_type`

    - MFL: `r paste(z_types, sep = ", ")`
    - WHO: `r paste(unlist(who_fac_types$types[who_fac_types$country == "Zambia"]), collapse = ", ")`
    - healthsites.io: `r paste(unlist(hs_fac_types$types[hs_fac_types$country == "Zambia"]), collapse = ", ")`

### Recommended facility attributes in an MFL

According to [_HIS geo-enabling: Guidance on the establishment of a common geo-registry for the simultaneous hosting,
maintenance, update and sharing of master lists core to public health_](https://healthgeolab.net/DOCUMENTS/Guidance_Common_Geo-registry_Ve1.pdf) developed in 2017 by the AeHINGIS Lab and InSTEDD through funding from the Asian Development Bank, information included in an MFL are split into two domains: the _signature domain_ (ellaborated on below) and the _service domain_ (that includes information about services and capacity of a health facility).

The service domain include the following:

1. Health facility identifier: Official unique identifier attached to the health facility
2. Health facility name: Official name of the health facility in both English and local
language
3. Address: street name and number in which the health facility is located (when
applicable)
4. Location in the administrative structure: Official name and code of the administrative
divisions in which the health facility is located and this down to the lowest existing
administrative level (a separated set of fields for each level)
5. Location in the reporting structure: Official name and code of the reporting divisions in
which the health facility is located and this down to the lowest existing reporting level
(when applicable and with a separated set of fields for each level)
6. Geographic coordinates: latitude and longitude of the health facility expressed in decimal
degrees together with the indication of the source, method and accuracy level attached
to the coordinates (a separate field for each information)
7. Health facility type: Type of the health facility based on the official classification used in
the country
8. Health facility ownership or managing authority: Major (government, private) and sub
classification (Ministry of Health, army, police,...) describing the entity that owns or
manage the health facility. (may require for the use of separated fields)
9. Past health facility names: Official names previously attached to the health facility (may
require for the use of several fields)
10. Health facility contact information: Information needed to contact the health facility
through different media including but not limited to the full name and position of the
health facility head as well as the phone numbers (mobile, landline) and email address
(to be captured in separated fields)
11. Health facility status: To be able to capture in the common geo-registry if the health
facility is active or inactive and the reason for inactivity if the later applies (to be captured
in separated fields)

The guide strongly recommends that each datasource is indicated along with a time stamp for when the data was obtained. This will effectively result in three columns for each data point: the first containing the information such as the identifier, name, or coordinates; the second containing the source; and the third containing the date and time stamp of when it was obtained.

According to this document, the capturing of service domain and other information not mentioned above form part of the optional component of the MFL.

```{r recommended_attributes}

recommende_attr <- tibble(
  facility_id = as.character(),
  facility_id_source = as.character(),
  facility_id_timestamp = as.date(),
  legacy_ids = as.list(),
  legacy_ids_source = as.character(),
  legacy_ids_timestamp = as.date(),
  facility_name = as.character(),
  facility_name_date = as.character(),
  facility_name_timestamp = as.date(),
  previous_names = as.list(),
  previous_names_date = as.list(), # list of as.character()
  previous_names_timestamp = as.list(), # list of as.date()
  facility_type = as.character(),
  type_date = as.character(),
  type_timestamp = as.date(),
  ownership = as.list(), # may have various levels of ownership - all should be listed
  ownership_date = as.list(), # list of as.character() 
  ownership_timestamp = as.list(), # list of as.date()
  contact_landline = as.character(),
  contact_landline_date = as.character(),
  contact_landline_timestamp = as.date(),
  contact_mobile = as.character(),
  contact_mobile_date = as.character(),
  contact_mobile_timestamp = as.date(),
  contact_email = as.character(),
  contact_email_date = as.character(),
  contact_email_timestamp = as.date(),
  facility_head_name = as.character(),
  facility_head_name_date = as.character(),
  facility_head_name_timestamp = as.date(),
  facility_head_surname = as.character(),
  facility_head_surname_date = as.character(),
  facility_head_surname_timestamp = as.date(),
  facility_head_position = as.character(),
  facility_head_position_date = as.character(),
  facility_head_position_timestamp = as.date(),
  address = as.character(),
  address_date = as.character(),
  address_timestamp = as.date(),
  admin_level2_code = as.character(),
  admin_level2_date = as.character(),
  admin_level2_timestamp = as.date(),
  admin_level2_name = as.character(),
  admin_level3_code = as.character(),
  admin_level3_name = as.character(),
  admin_level4_code = as.character(),
  admin_level4_name = as.character(),
  report_level1_name = as.character(),
  report_level1_code = as.character(),
  report_level2_name = as.character(),
  report_level2_code = as.character(),
  report_level3_name = as.character(),
  report_level3_code = as.character(),
  latitude = as.numeric(),
  longitude = as.numeric(),
  facility_status = as.character(),
  facility_status_comment = as.character(),
  date_opened = as.character(),
  date_closed = as.character(),
  website = as.character(),
  services = as.list(),
  infrastructure = as.list()
  )

```


```{r cleanup_facility_types}

remove(k_types, m_types, r_types, s_types, t_types, z_types, names_who, datasets_who, who_country, who_types, names_hs, datasets_hs, hs_country, hs_types, who, hs, hs_fac_types, who_fac_types)

```

## Facility attributes

Taking a closer look at the type of attributes that are available from country MFLs and other open data sources we notice great variability in terms of how well facililties are described. The table below shows the column headers for each dataset.

```{r table_headers}

# Create a vector containing the column headers for each dataset but filled up with empty space 
# Want to create a tibble with each dataset's headers as a column and therefore we need the vectors to be of equal length
# HS data has the most headers, so we use that as basis and make all vectors as long as HS 
fill_col <- function(df){
  # Calculate the difference in header numbers between healthsites data and the target dataset
  fill_number <- length(colnames(ken_hs)) - length(colnames(df))
  # Create the vector where the first elements are the sorted column names of the target dataset
  col_data <- sort(colnames(df))
  # Fill the rest of the vector with empty cells to be able to create the tibble
  for (i in 1:fill_number){
    col_data <- append(col_data, "")
  }
  # Return the vector of specified length
  return(col_data)
}

# Create a table with columns = header names sorted alphabetically
table_headers <- tibble(`healthsite.io` = sort(colnames(ken_hs)),
                        WHO = fill_col(ken_who),
                        `Kenya MFL` = fill_col(ken_mfl),
                        `Malawi MFL` = fill_col(mwi_mfl),
                        `Namibia MFL` = fill_col(nam_mfl),
                        `Rwanda MFL` = fill_col(rwa_mfl),
                        `South Sudan MFL` = fill_col(ssd_mfl),
                        `Tanzania MFL` = fill_col(tza_mfl),
                        `Zambia MFL` = fill_col(zmb_mfl)
                        )


```

```{r dataset_column_headers_table}

table_headers %>%  kableExtra::kable() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) %>% 
  kableExtra::scroll_box(width = "100%")

# Clean up
remove(table_headers, fill_col)

```


<br>

We can use a visual way to look at the overlap of attributes between various datasets through a wordcloud.

```{r wordcloud}

library(tm)
library(ggwordcloud)

# Used this tutorial to create frequency table:
# https://www.pluralsight.com/guides/visualization-text-data-using-word-cloud-r
# Create corpus
corpus <- Corpus(VectorSource(c(colnames(ken_hs), colnames(ken_who), 
                                  colnames(ken_mfl), colnames(mwi_mfl), colnames(nam_mfl),
                                  colnames(rwa_mfl), colnames(ssd_mfl), colnames(tza_mfl), colnames(zmb_mfl))))
#Conversion to Lowercase
corpus = tm_map(corpus, PlainTextDocument)
corpus = tm_map(corpus, tolower)

# Create frequency table
DTM <- TermDocumentMatrix(corpus)
mat <- as.matrix(DTM)
f <- sort(rowSums(mat),decreasing=TRUE)
dat <- data.frame(word = names(f),freq=f)
# Plot wordcloud 
ggwordcloud::ggwordcloud2(dat, size=1.2)

# Clean up
remove(corpus, DTM, mat, f, dat)
```
